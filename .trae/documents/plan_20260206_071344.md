# 项目重构实施计划

本计划旨在重构现有 AI 动漫生成平台，提升系统稳定性、可扩展性及可维护性。我们将从架构分层、API 核心优化、扩展性设计及监控体系四个维度进行改造。

## 1. 架构重构与目录调整
将业务逻辑从 `app/api` 和 `lib/ai-providers` 中抽离，构建独立的 `lib/api` 核心层，实现真正的分层架构。

### 新增目录结构
```
lib/
  api/
    core/           # 核心基础能力
      client.ts     # 统一 HTTP 客户端 (超时/重试/拦截器)
      logger.ts     # 分级日志系统 (Debug/Info/Error)
      types.ts      # 统一接口定义
      errors.ts     # 自定义错误类
    providers/      # 厂商实现
      jimeng/       # 即梦 (Volcengine)
      kling/        # 可灵 (Kling AI)
      _template/    # 标准接入模板
    middleware/     # 逻辑中间件
      validate.ts   # Zod 参数校验
      auth.ts       # 内部鉴权 (如有需要)
```

### 路由版本控制
- 新增 `app/api/v1/` 目录，所有新接口迁移至此（如 `app/api/v1/generate/route.ts`）。
- 现有 `app/api/generate` 将作为兼容层或重定向至 v1。

## 2. 核心功能实现

### 2.1 统一通信核心 (`lib/api/core`)
- **HttpClient**: 封装 `fetch`，内置：
  - **超时控制**: 默认 5s（即梦），可配置。
  - **重试机制**: 指数退避策略 (Exponential Backoff)，针对 5xx 和特定 429 错误重试。
  - **日志拦截**: 自动记录 Request/Response 的 Headers 和 Body（脱敏后）。
- **Logger**: 基于 `NEXT_PUBLIC_API_DEBUG` 环境变量控制输出，格式化为带时间戳、RequestID 的中文日志。

### 2.2 厂商接口深度适配
- **即梦 (Jimeng)**:
  - 迁移至 `lib/api/providers/jimeng`。
  - 集成 `aws4` 签名到 HttpClient 拦截器中。
  - 完善错误处理，将上游错误码映射为系统标准错误。
- **可灵 (Kling)**:
  - 迁移至 `lib/api/providers/kling`。
  - 实现 JWT 自动刷新/缓存机制。
  - 增加请求参数 Zod 校验（如 `model_name`, `aspect_ratio` 枚举检查）。

### 2.3 中间件与增强
- **参数验证**: 使用 `zod` 库对 API 输入进行严格校验，拒绝非法请求。
- **错误归一化**: 所有 API 统一返回 `{ code, message, data, traceId }` 格式。

## 3. 监控与调试
- **Sentry 集成**: 安装 `@sentry/nextjs`，捕获未处理异常和性能数据。
- **调试工具**:
  - 在 `docs/` 目录下生成 `api-collection.json` (Postman 格式)。
  - 提供 `API_README.md` 说明接口规范和错误码。

## 4. 实施步骤

1.  **环境准备**: 安装 `zod`, `@sentry/nextjs`, `winston` (可选，或使用轻量级自研 logger)。
2.  **核心层开发**: 实现 Logger 和 HttpClient。
3.  **迁移适配**: 将即梦和可灵的逻辑迁移到新架构，并应用重试/超时配置。
4.  **路由接入**: 创建 `/api/v1` 路由并联调。
5.  **文档与测试**: 生成文档，进行连通性测试。

## 5. 依赖变更
将安装以下 npm 包：
- `zod`: 用于运行时参数校验。
- `@sentry/nextjs`: 用于错误监控。
- `uuid`: 用于生成 RequestID（如果尚无）。

请确认是否开始执行此计划？